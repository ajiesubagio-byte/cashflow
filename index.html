<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cashflow - Input & Laporan</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--accent:#2563eb}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    h1{margin:0 0 8px;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(13,18,30,0.06)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="date"], select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
    .row{display:flex;gap:8px}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:white;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #dbeafe}
    .small{font-size:13px;padding:6px 10px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eef2ff;text-align:left;font-size:14px}
    th{font-weight:600;color:#111827}
    .muted{color:var(--muted)}
    .summary{display:flex;gap:12px;margin-top:12px}
    .stat{background:#f8fafc;padding:10px;border-radius:10px;min-width:120px}
    .empty{padding:20px;text-align:center;color:var(--muted)}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Cashflow â€” Input & Laporan</h1>
    <p class="muted">Masukkan transaksi, pilih jenis (Masuk / Keluar) dan kategori (Sandang / Pangan). Lihat laporan harian, bulanan, dan tahunan.</p>

    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Daftar Transaksi</strong>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <select id="filterType"><option value="all">Semua Jenis</option><option value="Masuk">Masuk</option><option value="Keluar">Keluar</option></select>
            <select id="filterCategory"><option value="all">Semua Kategori</option><option value="Sandang">Sandang</option><option value="Pangan">Pangan</option></select>
            <input id="searchText" type="text" placeholder="cari keterangan...">
            <button class="btn ghost small" id="resetFilters">Reset</button>
          </div>
        </div>

        <table id="txTable"><thead><tr><th>Tanggal</th><th>Keterangan</th><th>Jenis</th><th>Kategori</th><th>Nominal</th><th>Aksi</th></tr></thead><tbody id="txBody"></tbody></table>
        <div id="emptyList" class="empty">Belum ada transaksi.</div>

        <div class="summary">
          <div class="stat"><div class="muted">Total Masuk</div><div id="totalIn">Rp 0</div></div>
          <div class="stat"><div class="muted">Total Keluar</div><div id="totalOut">Rp 0</div></div>
          <div class="stat"><div class="muted">Saldo (Net)</div><div id="net">Rp 0</div></div>
        </div>

        <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn small" id="exportJson">Export JSON</button>
          <button class="btn ghost small" id="clearAll">Clear Semua</button>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px dashed #eef2ff">

        <div style="display:flex;gap:8px;align-items:center">
          <select id="reportRange"><option value="daily">Harian</option><option value="monthly">Bulanan</option><option value="yearly">Tahunan</option></select>
          <input id="reportDate" type="date">
          <select id="reportCategory"><option value="all">Semua Kategori</option><option value="Sandang">Sandang</option><option value="Pangan">Pangan</option></select>
          <button class="btn small" id="runReport">Jalankan</button>
        </div>

        <div id="reportResult" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <strong id="formTitle">Tambah Transaksi</strong>
        <div style="margin-top:8px">
          <label>Tanggal</label><input id="date" type="date">
          <label style="margin-top:8px">Nominal (Rp)</label><input id="nominal" type="number" min="0">
          <label style="margin-top:8px">Jenis</label><select id="type"><option value="Masuk">Masuk</option><option value="Keluar">Keluar</option></select>
          <label style="margin-top:8px">Kategori</label><select id="category"><option value="Sandang">Sandang</option><option value="Pangan">Pangan</option></select>
          <label style="margin-top:8px">Keterangan</label><input id="note" type="text">

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="addBtn">Tambah</button>
            <button class="btn ghost" id="updateBtn" style="display:none">Simpan Perubahan</button>
            <button class="btn ghost" id="cancelEdit" style="display:none">Batal</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwRU_Is-jLighxJPkQMktm-B-ydejNvzrFly88JE_DQxKG2JpKXSwxgTnNw_oui4KPkAg/exec";
let entries = [];
let editingId = null;

const qs = s => document.querySelector(s);
const money = n => 'Rp ' + Number(n).toLocaleString('id-ID');

const txBody = qs('#txBody');
const emptyList = qs('#emptyList');
const totalInEl = qs('#totalIn');
const totalOutEl = qs('#totalOut');
const netEl = qs('#net');

const dateEl = qs('#date');
const nominalEl = qs('#nominal');
const typeEl = qs('#type');
const categoryEl = qs('#category');
const noteEl = qs('#note');
const addBtn = qs('#addBtn');
const updateBtn = qs('#updateBtn');
const cancelEdit = qs('#cancelEdit');

function formatDateDisplay(d){return new Date(d).toLocaleDateString("id-ID",{day:'2-digit',month:'2-digit',year:'numeric'});}
function formatDateInput(d){return new Date(d).toISOString().slice(0,10);}

async function load(){
  const res = await fetch(API+"?action=getAll");
  entries = await res.json();
  renderList();
}

function clearForm(){dateEl.value="";nominalEl.value="";typeEl.value="Masuk";categoryEl.value="Sandang";noteEl.value="";}
function toggleEdit(on){qs('#formTitle').textContent=on?'Ubah Transaksi':'Tambah Transaksi';addBtn.style.display=on?'none':'inline-block';updateBtn.style.display=on?'inline-block':'none';cancelEdit.style.display=on?'inline-block':'none';}

async function deleteItem(id){if(confirm("Hapus?")){await fetch(API+"?action=delete&id="+id);load();}}
function editItem(id){let x=entries.find(v=>v.id==id);editingId=id;dateEl.value=formatDateInput(x.date);nominalEl.value=x.nominal;typeEl.value=x.type;categoryEl.value=x.category;noteEl.value=x.note;toggleEdit(true);}

function renderList(){
  let list = [...entries].sort((a,b)=>b.date.localeCompare(a.date));
  txBody.innerHTML="";
  if(!list.length){qs("#txTable").style.display="none";emptyList.style.display="block";return;}
  qs("#txTable").style.display="table";emptyList.style.display="none";
  list.forEach(x=>{
    txBody.insertAdjacentHTML("beforeend",`
    <tr>
      <td>${formatDateDisplay(x.date)}</td>
      <td>${x.note||""}</td>
      <td>${x.type}</td>
      <td>${x.category}</td>
      <td>${money(x.nominal)}</td>
      <td><button class="btn ghost small" onclick="editItem('${x.id}')">Edit</button>
      <button class="btn ghost small" onclick="deleteItem('${x.id}')">Hapus</button></td>
    </tr>`);});
  const tin = entries.filter(x=>x.type=="Masuk").reduce((s,v)=>s+Number(v.nominal),0);
  const tout = entries.filter(x=>x.type=="Keluar").reduce((s,v)=>s+Number(v.nominal),0);
  totalInEl.textContent = money(tin);
  totalOutEl.textContent = money(tout);
  netEl.textContent = money(tin-tout);
}

addBtn.onclick=async()=>{if(nominalEl.value<=0)return alert("Nominal harus > 0");await fetch(API+"?action=add&"+new URLSearchParams({date:dateEl.value,nominal:nominalEl.value,type:typeEl.value,category:categoryEl.value,note:noteEl.value}));clearForm();load();}
updateBtn.onclick=async()=>{await fetch(API+"?action=update&"+new URLSearchParams({id:editingId,date:dateEl.value,nominal:nominalEl.value,type:typeEl.value,category:categoryEl.value,note:noteEl.value}));editingId=null;toggleEdit(false);clearForm();load();}
cancelEdit.onclick=()=>{editingId=null;toggleEdit(false);clearForm();}
load();
</script>
</body>
</html>
